{% extends "base.html" %}
{% load humanize %}
{% load extra_tags %}

{% block title %}Overview{% endblock %}

{% block content %}

<div class="u-flex u-flex-column u-gap-4">
    {% if active_user_settings.show_tutorials %}
        <div>
            <details class="accordion card card_colors max-w-md">
                <summary class="accordion__summary">Tutorial notes</summary>
                <p>
                    This shows just about everything about this dominion at a glance. If you and this dominion are both out of protection, it also has
                    the interface for invading them. In order to invade someone, you need to send an amount of offense that matches or exceeds their defense.
                </p>
                <p>
                    On an invasion, the attacker takes 10% casualties if they win and 15% casualties if they lose. The defender takes 5% casualties if 
                    they lose, 2% casualties if they win, and no casualties if the offense less than half the defense. Of course, the attacker will likely
                    always win, because the total offense and defense are both public information.
                </p>
                <p>
                    Some units have special perks. These are marked by differently-colored text and the description can be seen by mousing over the name (desktop)
                    or tapping on the name (mobile).
                </p>
                <p>
                    Every tick, a dominion gains 1 complacency, giving -0.33% defense each. Complacency resets when that dominion gets invaded. They also gain 1
                    determination, giving +0.33% offense each and resetting when they successfully invade another dominion.
                </p>
            </details>
        </div>
    {% endif %}
    <div>
        <h6>{{ dominion.name }}</h6>
        <h6>{{ dominion.acres }} acres</h6>
        {% if dominion == active_dominion or round.has_started and dominion.protection_ticks_remaining == 0 %}
        <h6>{{ dominion.defense|intcomma }} defense</h6>
        {% else %}
        <h6>Defense hidden while under magical protection</h6>
        {% endif %}
        <h6>{{ dominion.successful_invasions }} successful invasions, {{ dominion.failed_defenses }} failed defenses
        <h6>Ruled by {{ dominion.rulers_display_name }}</h6>
    </div>

    {% if dominion != active_dominion and dominion.protection_ticks_remaining == 0 and active_dominion.can_attack and round.has_started and not round.has_ended and not dominion.is_abandoned %}
    <form action="{% url 'submit_invasion' dominion.id %}" method="post" class="max-w-md u-overflow-x-scroll">
        {% csrf_token %}
        <div class="w-100p u-center">
            <h6>Plan invasion for {{ acres_conquered}} acres</h6>
        </div>
        <table class="table striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Power</th>
                    <th>At home</th>
                    <th class="w-16">Send</th>
                </tr>
            </thead>
            <tbody>
                {% for unit in my_units %}
                <tr>
                    {% include "maingame/unit_name_row.html" %}
                    <td class="u-align-middle" id="power_{{ unit.id }}" style="white-space:nowrap">{{ unit.op|intcomma }} / {{ unit.dp|intcomma }}</td>
                    <td class="u-align-middle">{{ unit.quantity_at_home|intcomma }}</td>
                    <td class="u-align-middle u-flex-md u-flex-row-md">
                        <input 
                            name="send_{{ unit.id }}" 
                            id="send_{{ unit.id }}" 
                            type="number" 
                            min="0"
                            max="{{ unit.quantity_at_home }}" 
                            class="w-12 w-16-md ml-auto-md mr-2-md unitInput"
                            oninput="updateOffenseToSend()"
                        >
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div>
            <div id="readoutSection" class="u-center u-flex u-gap-1 text-red-400">
                <span id="opToSend">0</span>
                <span>OP</span>
                <span>vs.</span>
                <span id="dpHere">{{ dominion.defense|intcomma }}</span>
                <span> DP</span>
            </div>
            <div class="u-center u-flex u-gap-1">
                <span>You'll have</span>
                <span id="dpLeft">{{ active_dominion.defense }}</span>
                <span>defense after attacking</span>
            </div>
        </div>
        <div style="display: none;">
            <input type="submit" name="prevent-enter-submit" onclick="return false;">
        </div>
        <button class="btn-danger mt-1 w-24 h-6 p-0 u-center" type="submit">
            <span id="invadeButtonText" class="font-bold">Invade</span>
        </button>
    </form>

    <script>
        const offenseMultiplier = JSON.parse('{{ offense_multiplier|escapejs }}');
        const rawDefense = JSON.parse('{{ raw_defense|escapejs }}');
        const defenseMultiplier = JSON.parse('{{ defense_multiplier|escapejs }}');

        function updateOffenseToSend() {
            let opReadout = document.getElementById("opToSend");
            let dpLeftReadout = document.getElementById("dpLeft");
            let dpHere = document.getElementById("dpHere").innerHTML;
            dpHere = parseInt(dpHere.replace(',', ''));
            let readoutSection = document.getElementById("readoutSection");
            let invadeButtonText = document.getElementById("invadeButtonText");
            let unitInputs = document.getElementsByClassName("unitInput")

            let totalOp = 0
            let dpSent = 0

            for (const [key, value] of Object.entries(unitInputs)) {
                unitId = value.id.substr(5)
                let op = document.getElementById("power_" + unitId).innerHTML.split("/")[0]
                let dp = document.getElementById("power_" + unitId).innerHTML.split("/")[1]
                op = parseInt(op.replace(/,/g, ''))
                dp = parseInt(dp.replace(/,/g, ''))
                totalOp = totalOp + value.value * op
                dpSent = dpSent + value.value * dp
            }

            totalOp = Math.floor(totalOp * offenseMultiplier)
            opReadout.innerHTML = totalOp
            dpLeftReadout.innerHTML = Math.floor((rawDefense - dpSent) * defenseMultiplier)

            if (totalOp >= dpHere) {
                readoutSection.classList.remove("text-red-400")
                readoutSection.classList.add("text-green-400")
                invadeButtonText.classList.remove("text-red-400")
            } else {
                readoutSection.classList.remove("text-green-400")
                readoutSection.classList.add("text-red-400")
                invadeButtonText.classList.add("text-red-400")
            }
        }

        function updateDefenseHere(regionDefense) {
            const regionDefenstInt = parseInt(regionDefense)
            let dpReadout = document.getElementById("dp-left");
            const unitHereInputs = document.getElementsByClassName("unitHereInput")
            let totalLostDp = 0

            for (const [key, value] of Object.entries(unitHereInputs)) {
                unitId = value.id.substr(8)
                const dp = document.getElementById("power_" + unitId).innerHTML.split("/")[1]
                totalLostDp = totalLostDp + value.value * dp
            }

            dpReadout.innerHTML = regionDefenstInt - totalLostDp
        }
    </script>
    {% else %}
    <h6>Can't invade this dominion</h6>
    {% endif %}

    <div class="">
        <table class="table striped max-w-md">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Quantity</th>
                    <th>Produced</th>
                    <th>Spent</th>
                    <th>Net</th>
                </tr>
            </thead>
            <tbody>
                {% for key, value in resources_dict.items %}
                <tr>
                    <th class="u-align-middle">{{ value.name|title }}</th>
                    <td class="u-align-middle">{{ value.quantity|intcomma }}</td>
                    <td class="u-align-middle text-green-400">{{ value.produced|intcomma }}</td>
                    <td class="u-align-middle text-red-400">{{ value.consumed|intcomma }}</td>
                    <td class="u-align-middle {% if value.net < 0 %}text-red-400{% else %}text-green-400{% endif %}">{{ value.net|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if dominion == active_dominion or round.has_started and dominion.protection_ticks_remaining == 0 %}
    <div>
        <table class="table striped small max-w-sm">
            <thead>
                <tr>
                    <th>Unit</th>
                    <th>Power</th>
                    <th>Quantity (Training)</th>
                    <th>At home</th>
                </tr>
            </thead>
            <tbody>
                {% for unit in units %}
                    <tr>
                        {% include "maingame/unit_name_row.html" %}
                        <td class="u-align-middle" style="white-space:nowrap">{{ unit.op|intcomma }} / {{ unit.dp|intcomma }}</td>
                        <td class="tooltip tooltip--right" data-tooltip="{{ unit.quantity_total_and_paid }}">{{ unit.quantity_trained_and_alive|intcomma }} {% if unit.quantity_in_training > 0 %} ({{ unit.quantity_in_training|intcomma }}){% endif %}</td>
                        <td class="u-align-middle">{{ unit.quantity_at_home|intcomma }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <h6>Units will be displayed here once this dominion is out of protection and the round has started.</h6>
    {% endif %}

    <div>
        <table class="table striped small max-w-xs">
            <thead>
                <tr>
                    <th>Building</th>
                    <th>Quantity</th>
                    <th>Pct</th>
                    <th>Upgrades</th>
                </tr>
            </thead>
            <tbody>
                {% for building in buildings %}
                    <tr>
                        {% include "maingame/tooltip_td.html" with have_tooltip=True main_text=building.name tooltip_text=building.description %}
                        <td class="u-align-middle">{{ building.quantity|intcomma }}</td>
                        <td class="u-align-middle">{{ building.percent }}%</th>
                        <td class="u-align-middle">{{ building.upgrades }}</th>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="u-flex u-flex-column max-w-md card card_colors p-1">
        <div>
            <h6 class="u-center">Units returning from battle</h6>
        </div>
        <div class="u-overflow-x-scroll u-overflow-x-hidden-md">
            <table class="table striped card_colors">
                <thead>
                    <tr>
                        <th class="w-24">Unit</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                        <th>11</th>
                        <th>12</th>
                    </tr>
                </thead>
                <tbody>
                    {% for unit in units %}
                    {% if unit.quantity_returning > 0 %}
                        <tr>
                            <th class="u-align-middle">{{ unit.name|title }}</th>
                            <td class="u-align-middle">{{ unit.returning_dict.1|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.2|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.3|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.4|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.5|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.6|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.7|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.8|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.9|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.10|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.11|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.returning_dict.12|no_zeroes }}</td>
                        </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="u-flex u-flex-column max-w-md card card_colors p-1">
        <div>
            <h6 class="u-center ">Incoming acres</h6>
        </div>
        <div class="u-overflow-x-scroll u-overflow-x-hidden-md">
            <table class="table striped card_colors">
                <thead>
                    <tr>
                        <th class="w-24">Acres</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                        <th>11</th>
                        <th>12</th>
                    </tr>
                </thead>
                <tbody>
                    {% if active_dominion.incoming_acres > 0 %}
                    <tr>
                        <td class="u-align-middle">Acres</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.1|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.2|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.3|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.4|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.5|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.6|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.7|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.8|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.9|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.10|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.11|no_zeroes }}</td>
                        <td class="u-align-middle">{{ dominion.incoming_acres_dict.12|no_zeroes }}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    {% if dominion == active_dominion or round.has_started and dominion.protection_ticks_remaining == 0 %}
    <div class="u-flex u-flex-column max-w-md card card_colors p-1">
        <div>
            <h6 class="u-center">Units in training</h6>
        </div>
        <div class="u-overflow-x-scroll u-overflow-x-hidden-md">
            <table class="table striped card_colors">
                <thead>
                    <tr>
                        <th class="w-24">Unit</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                        <th>11</th>
                        <th>12</th>
                    </tr>
                </thead>
                <tbody>
                    {% for unit in units %}
                    {% if unit.quantity_in_training > 0 %}
                        <tr>
                            <th class="u-align-middle">{{ unit.name|title }}</th>
                            <td class="u-align-middle">{{ unit.training_dict.1|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.2|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.3|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.4|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.5|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.6|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.7|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.8|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.9|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.10|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.11|no_zeroes }}</td>
                            <td class="u-align-middle">{{ unit.training_dict.12|no_zeroes }}</td>
                        </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <h6>Units in training will be displayed here once this dominion is out of protection and the round has started.</h6>
    {% endif %}

    <div class="max-w-xs">
        <details class="accordion">
            <summary class="accordion__summary header_colors u-round-xs"><span class="u-center">Spells</span></summary>
            <div>
                {% for spell in spells %}
                <div class="card card_colors p-1 u-flex u-flex-column u-gap-1">
                    <h6>{{ spell.name }}</h6>
                    <span>Mana cost: {{ spell.mana_cost }} ({{ spell.mana_cost_per_acre }}/acre)</span>
                    <span>{{ spell.description }}</span>
                </div>
                {% endfor %}
            </div>
        </details>
        <div />
        <details class="accordion">
            <summary class="accordion__summary header_colors u-round-xs"><span class="u-center">Discoveries</span></summary>
            <div>
                {% for discovery in learned_discoveries %}
                <div class="card card_colors p-1 u-flex u-flex-column u-gap-1">
                    <h6>{{ discovery.name }}</h6>
                    <span>{{ discovery.description }}</span>
                </div>
                {% endfor %}
            </div>
        </details>
    </div>

    <p>Complacency: {{ dominion.complacency }} ticks (-{{ dominion.complacency_penalty_percent }}% defense)</p>

    {% if dominion == active_dominion %}
    <div>
        <form action="{% url 'abandon' %}" method="post" class="u-flex u-flex-column u-gap-4">
            {% csrf_token %}
            <div class="form-ext-control pl-0 w-32 mt-8">
                <div class="u-flex u-flex-column">
                    <h6>Abandon</h6>
                    <span>You will lose ownership of your dominion and you can re-register with a new one.</span>
                </div>
                <label class="form-ext-toggle__label u-flex u-flex-row w-24 mt-2">
                    <span>Do it</span>
                    <div class="form-ext-toggle">
                        <input name="abandon" type="checkbox" class="form-ext-input" />
                        <div class="form-ext-toggle__toggler"><i></i></div>
                    </div>
                </label>
                <label class="form-ext-toggle__label u-flex u-flex-row w-32 mt-2">
                    <span class="w-24">Really do it</span>
                    <select name="confirm_abandon">
                        <option></option>
                        <option>REALLY DO IT</option>
                    </select>
                </label>
                <button class="header_colors mt-4 w-16 h-6 p-0 u-center" type="submit">
                    <span class="font-bold">Submit</span>
                </button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

{% endblock %}
