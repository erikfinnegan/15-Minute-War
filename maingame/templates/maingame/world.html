{% extends "base.html" %}
{% load humanize %}
{% load extra_tags %}

{% block title %}The World{% endblock %}

{% block tutorial %}
{% include "maingame/tutorial_text.html" with page="world" %}
{% endblock %}

{% block content %}
<div>
    <details class="accordion card card_colors max-w-md">
        <summary class="accordion__summary">Details</summary>
            <p>
                These are all the dominions at the moment. When someone makes an invasion, the units they send take 12 ticks to return home, leaving 
                them more vulnerable to attack in the meantime.
            </p>
            <p>
                On an invasion, the attacker takes 10% casualties if they win and 15% casualties if they lose. The defender takes 5% casualties if 
                they lose, 2% casualties if they win, and no casualties if the offense less than half the defense. Of course, the attacker will likely
                win, because the total offense and defense are both public information.
            </p>
            <p>
                Every tick, a dominion gains -0.33% defense. This resets when that dominion gets invaded. They also gain +0.33% offense, which
                resets when they successfully invade another dominion.
            </p>
    </details>

    <div class="u-overflow-x-scroll u-overflow-x-auto-md pr-2 max-w-md">
        <table class="table striped max-w-md">
            <thead>
                <tr class="header_colors">
                    <th class="u-align-middle">
                        <div class="u-flex u-flex-column">
                            <span>Dominion</span>
                            <small>Click for overview</small>
                        </div>
                    </th>
                    <th class="u-align-middle">Land</th>
                    <th class="u-align-middle">Defense</th>
                    <th class="u-align-middle">Bonuses</th>
                    <th class="u-align-middle">Highest OP</th>
                    {% if "book_of_grudges" in active_dominion.perk_dict %}
                    <th class="u-align-middle">Grudges</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for dominion in dominions %}
                <tr class="{% if dominion == active_dominion %}font-bold{% endif %}">

                    {% comment %} Dominion {% endcomment %}
                    <td class="u-align-middle">
                        <div class="u-flex u-flex-column">
                            <a class="font-bold" href="{% url 'overview' dominion.id %}">{{ dominion.name }}</a>
                            <a href="{% url 'overview' dominion.id %}"><small class="{% if dominion == active_dominion %}font-bold{% endif %}">{{ dominion.rulers_display_name }}</small></a>
                            <a href="{% url 'overview' dominion.id %}"><small class="{% if dominion == active_dominion %}font-bold{% endif %}">{{ dominion.faction_name|title }}</small></a>
                        </div>
                    </td>

                    {% comment %} Land {% endcomment %}
                    <td class="u-align-middle">
                        {% include "maingame/current_incoming.html" with current=dominion.acres incoming=dominion.incoming_acres %}
                    </td>

                    {% comment %} Defense {% endcomment %}
                    <td class="u-align-middle">
                        <div class="u-flex u-flex-column">
                            {% if dominion.defense < active_dominion.juicy_target_threshold and dominion.protection_ticks_remaining == 0 %}
                            <span class="tag tag--danger py-0 mx-auto text-md">{{ dominion.defense_short }}</span>
                            {% else %}
                            <span class="u-center {% if dominion.protection_ticks_remaining > 0 or not round.has_started %}text-teal-400{% endif %}">
                                {% if dominion.protection_ticks_remaining == 0 and round.has_started %}{{ dominion.defense_short }}{% else %}Magical protection{% endif %}
                            </span>
                            {% endif %}
                            {% if dominion.has_units_returning %}
                            <small>Units return in {{ dominion.ticks_til_soonest_return }} ticks</small>
                            {% endif %}
                        </div>
                    </td>

                    {% comment %} Bonuses {% endcomment %}
                    <td class="u-align-middle">
                        <div class="u-flex u-flex-column">
                            <span>+{{ dominion.determination_bonus_percent|floatformat:0 }}% OP</span>
                            <span>-{{ dominion.complacency_penalty_percent|floatformat:0 }}% DP</span>
                        </div>
                    </td>

                    {% comment %} Highest OP {% endcomment %}
                    <td class="u-align-middle">{{ dominion.highest_op_short }}</td>

                    {% comment %} Grudges {% endcomment %}
                    {% if "book_of_grudges" in active_dominion.perk_dict %}
                    {% if dominion.strid in active_dominion.perk_dict.book_of_grudges %}
                    <td class="u-align-middle">
                        <div class="u-flex u-flex-column u-center w-16">
                            <span>{{ active_dominion.perk_dict.book_of_grudges|getattr:dominion.strid|getattr:"pages" }} pages</span>
                            <span>+{{ active_dominion.perk_dict.book_of_grudges|getattr:dominion.strid|getattr:"animosity"|floatformat:"1" }}% OP</span>
                        </div>
                    </td>
                    {% else %}
                    <td class="u-align-middle">None</td>
                    {% endif %}
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% for dominion in dominions %}
    {% if dominion != active_dominion and dominion.protection_ticks_remaining == 0 and not dominion.is_abandoned %}
    {% endif %}
    {% endfor %}

    {% if active_dominion.can_attack and round.has_started and not round.has_ended %}
    <form action="{% url 'submit_invasion' %}" method="post" class="max-w-md u-overflow-x-scroll u-overflow-x-auto-md">
        {% csrf_token %}
        <div class="u-flex u-flex-row u-center py-2">
            <select class="max-w-xs" name="target_dominion_id" id="target_select_dropdown" oninput="updateTargetDefense(); updateOffenseToSend();">
                <option value="0">Select a target to plan an invasion</option>
                {% for dominion in dominions %}
                {% if dominion != active_dominion and dominion.protection_ticks_remaining == 0 and not dominion.is_abandoned %}
                <option value="{{ dominion.id }}">{{ dominion.name }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

        <div>
            <span class="u-center" id="acre_count_placeholder">Invasions discover extra acres equal to the amount conquered.</span>
            <div class="u-none u-gap-1 u-center" id="acre_count_sentence" style="visibiliy: hidden;">
                <span>This invasion would conquer</span>
                <span id="acre_count_number">0</span>
                <span>acres.</span>
            </div>
        </div>
        <table class="table striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Power</th>
                    <th>At home</th>
                    <th class="w-16">Send</th>
                </tr>
            </thead>
            <tbody>
                {% for unit in my_units %}
                <tr>
                    {% include "maingame/unit_name_row.html" %}
                    <td class="u-align-middle" id="power_{{ unit.id }}" style="white-space:nowrap">{{ unit.op|intcomma }} / {{ unit.dp|intcomma }}</td>
                    <td class="u-align-middle">{{ unit.quantity_at_home|intcomma }}</td>
                    <td class="u-align-middle u-flex-md u-flex-row-md">
                        <input 
                            name="send_{{ unit.id }}" 
                            id="send_{{ unit.id }}" 
                            type="number" 
                            min="0"
                            max="{{ unit.quantity_at_home }}" 
                            class="w-12 w-16-md ml-auto-md mr-2-md unitInput"
                            oninput="updateOffenseToSend()"
                        >
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div>
            <div id="readoutSection" class="u-center u-flex u-gap-1 text-red-400">
                <span id="opToSend">0</span>
                <span>OP</span>
                <span>vs.</span>
                <span id="dpHere">0</span>
                <span> DP</span>
            </div>
            <div class="u-center u-flex u-gap-1" id="dpLeftText">
                <span>You'll have</span>
                <span id="dpLeft">{{ active_dominion.defense }}</span>
                <span>defense after attacking</span>
            </div>
            <div class="u-center u-flex u-flex-column">
                <span id="largerEnemyHasLowerDefense" hidden>✅ an enemy larger than you has lower defense</span>
                <span id="youHaveTheLowestDefense" hidden>❌ you'll have the lowest DP in the game</span>
            </div>
            <input type="number" id="dpLeftHidden" name="dpLeftHidden" hidden value="{{ active_dominion.defense }}" />
        </div>
        <div style="display: none;">
            <input type="submit" name="prevent-enter-submit" onclick="return false;">
        </div>

        {% comment %} <marquee
            direction="down"
            width="1000"
            height="150"
            behavior="alternate"
            style="border:solid">
            <marquee behavior="alternate"><span id="bigscreen-time" class="u-center font-bold">
                <button class="btn-danger mt-1 w-24 h-6 p-0 u-center" type="submit">
                    <span id="invadeButtonText" class="font-bold">Invade</span>
                </button></span>
            </marquee>
        </marquee> {% endcomment %}
        {% comment %} <textarea placeholder="Smack talk"></textarea> {% endcomment %}

        <button class="btn-danger mt-1 w-24 h-6 p-0 u-center" type="submit" id="invadeButton" disabled>
            <span id="invadeButtonText" class="font-bold">Invade</span>
        </button>
    </form>

    <script>
        const rawDefense = JSON.parse('{{ raw_defense|escapejs }}');
        const defenseMultiplier = JSON.parse('{{ defense_multiplier|escapejs }}');
        const minimumDefenseLeft = JSON.parse('{{ minimum_defense_left|escapejs }}');
        const lowestDefenseLargerThanYou = JSON.parse('{{ lowest_defense_larger_than_you|escapejs }}');
        const lowestDefenseInTheGame = JSON.parse('{{ lowest_defense_in_game|escapejs }}');

        function updateTargetDefense() {
            const currentDefenseDict = JSON.parse('{{ current_defense_dict|escapejs }}');
            const landConqueredDict = JSON.parse('{{ land_conquered_dict|escapejs }}');
            const targetId = document.getElementById("target_select_dropdown").value;
            const invadeButton = document.getElementById("invadeButton")
            const dpHereReadout = document.getElementById("dpHere");
            const acreCountPlaceholder = document.getElementById("acre_count_placeholder");
            const acreCountSentence = document.getElementById("acre_count_sentence");
            const acreCountNumber = document.getElementById("acre_count_number");

            dpHereReadout.innerHTML = currentDefenseDict[targetId];
            invadeButton.disabled = targetId == 0
            
            if (targetId == 0) {
                acreCountPlaceholder.classList.remove("u-none")
                acreCountSentence.classList.add("u-none")
                acreCountSentence.classList.remove("u-flex")
                acreCountSentence.classList.remove("u-flex-wrap")
            } else {
                acreCountPlaceholder.classList.add("u-none")
                acreCountSentence.classList.remove("u-none")
                acreCountSentence.classList.add("u-flex")
                acreCountSentence.classList.add("u-flex-wrap")
                acreCountNumber.innerHTML = landConqueredDict[targetId]
            }
        }

        function updateOffenseToSend() {
            const offense_multiplier_dict = JSON.parse('{{ offense_multiplier_dict|escapejs }}');
            const baseOffenseMultiplier = JSON.parse('{{ base_offense_multiplier|escapejs }}');
            const targetId = document.getElementById("target_select_dropdown").value;
            let opReadout = document.getElementById("opToSend");
            let dpLeftReadout = document.getElementById("dpLeft");
            let dpLeftReadoutHidden = document.getElementById("dpLeftHidden");
            let dpLeftText = document.getElementById("dpLeftText");
            let dpHere = document.getElementById("dpHere").innerHTML;
            dpHere = parseInt(dpHere.replace(',', ''));
            let readoutSection = document.getElementById("readoutSection");
            let invadeButtonText = document.getElementById("invadeButtonText");
            let unitInputs = document.getElementsByClassName("unitInput")

            let totalOp = 0
            let dpSent = 0

            for (const [key, value] of Object.entries(unitInputs)) {
                unitId = value.id.substr(5)
                let op = document.getElementById("power_" + unitId).innerHTML.split("/")[0]
                let dp = document.getElementById("power_" + unitId).innerHTML.split("/")[1]
                op = parseInt(op.replace(/,/g, ''))
                dp = parseInt(dp.replace(/,/g, ''))
                totalOp = totalOp + value.value * op
                dpSent = dpSent + value.value * dp
            }

            let offense_multiplier = baseOffenseMultiplier
            if (targetId != 0) {
                offense_multiplier = offense_multiplier_dict[targetId]
            }

            totalOp = Math.floor(totalOp * offense_multiplier)
            opReadout.innerHTML = totalOp
            
            const dpLeft = Math.floor((rawDefense - dpSent) * defenseMultiplier)
            dpLeftReadout.innerHTML = dpLeft
            dpLeftReadoutHidden.value = dpLeft

            if (totalOp >= dpHere) {
                readoutSection.classList.remove("text-red-400")
                readoutSection.classList.add("text-green-400")
                invadeButtonText.classList.remove("text-red-400")
            } else {
                readoutSection.classList.remove("text-green-400")
                readoutSection.classList.add("text-red-400")
                invadeButtonText.classList.add("text-red-400")
            }

            if (dpLeft < minimumDefenseLeft) {
                dpLeftText.classList.add("text-red-400")
            } else {
                dpLeftText.classList.remove("text-red-400")
            }

            let largerEnemyHasLowerDefenseReadout = document.getElementById("largerEnemyHasLowerDefense");
            let youHaveTheLowestDefenseReadout = document.getElementById("youHaveTheLowestDefense");

            if (dpLeft > lowestDefenseLargerThanYou) {
                largerEnemyHasLowerDefenseReadout.hidden = false
            } else {
                largerEnemyHasLowerDefenseReadout.hidden = true
            }

            console.log(`my ${dpLeft} ...vs... their ${lowestDefenseInTheGame}`)

            if (dpLeft < lowestDefenseInTheGame) {
                youHaveTheLowestDefenseReadout.hidden = false
                console.log("you have lowest")
            } else {
                youHaveTheLowestDefenseReadout.hidden = true
                console.log("well, you're not lowest")
            }
        }

        function updateDefenseHere(regionDefense) {
            console.log("start")
            const regionDefenstInt = parseInt(regionDefense)
            let dpReadout = document.getElementById("dp-left");
            const unitHereInputs = document.getElementsByClassName("unitHereInput")
            let totalLostDp = 0

            for (const [key, value] of Object.entries(unitHereInputs)) {
                unitId = value.id.substr(8)
                const dp = document.getElementById("power_" + unitId).innerHTML.split("/")[1]
                totalLostDp = totalLostDp + value.value * dp
            }

            defenseLeft = regionDefenstInt - totalLostDp

            dpReadout.innerHTML = defenseLeft

            let largerEnemyHasLowerDefenseReadout = document.getElementById("largerEnemyHasLowerDefense");
            let youHaveTheLowestDefenseReadout = document.getElementById("youHaveTheLowestDefense");

            if (defenseLeft > lowestDefenseLargerThanYou) {
                largerEnemyHasLowerDefenseReadout.hidden = false
            } else {
                largerEnemyHasLowerDefenseReadout.hidden = true
            }

            if (defenseLeft < lowestDefenseInTheGame) {
                youHaveTheLowestDefenseReadout.hidden = false
                console.log("you have lowest")
            } else {
                youHaveTheLowestDefenseReadout.hidden = true
                console.log("well, you're not lowest")
            }
        }
    </script>
    {% endif %}
</div>
{% endblock %}
