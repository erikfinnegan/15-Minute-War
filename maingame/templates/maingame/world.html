{% extends "base.html" %}
{% load humanize %}
{% load extra_tags %}

{% block title %}The World{% endblock %}

{% block tutorial %}
{% include "maingame/tutorial_text.html" with page="world" %}
{% endblock %}

{% block content %}
<div>
    <details class="accordion card card_colors max-w-md">
        <summary class="accordion__summary">Tutorial notes</summary>
        <p>These are all the dominions at the moment. You can click the info button next to anyone's name to see an overview of their dominion.</p>
        <p>When someone makes an invasion, the units they send take 12 ticks to return home, leaving them more vulnerable to attack in the meantime.</p>
    </details>

    <div class="u-none u-block-md">
        <table class="table striped card_colors">
            <thead>
                <tr>
                    <th class="u-align-middle">Name</th>
                    <th class="u-align-middle">Player</th>
                    <th class="u-align-middle">Land</th>
                    <th class="u-align-middle">Faction</th>
                    <th class="u-align-middle">Defense</th>
                    <th class="u-align-middle">Complacency</th>
                    <th class="u-align-middle">Determination</th>
                    <th class="u-align-middle">Highest OP</th>
                    <th class="u-align-middle">Units Returning</th>
                    {% if "book_of_grudges" in active_dominion.perk_dict %}
                    <th class="u-align-middle">Grudges</th>
                    {% endif %}
                    <th class="u-align-middle">Info</th>
                </tr>
            </thead>
            <tbody>
                {% for dominion in dominions %}
                <tr class="{% if dominion == active_dominion %}font-bold{% endif %}">
                    <th class="u-align-middle">{{ dominion.name }}</td>

                    <td class="u-align-middle tooltip tooltip--right" data-tooltip="Theme: {{ dominion.rulers_theme_name }}">
                        {{ dominion.rulers_display_name }}
                    </td>

                    <td class="u-align-middle tooltip tooltip--right" data-tooltip="{{ dominion.acres_with_incoming }}">
                        {{ dominion.acres }}{% if dominion.incoming_acres > 0 %} ({{ dominion.incoming_acres }}){% endif %}
                    </td>

                    {% if dominion.faction_name == "dwarf" %}
                    <td class="u-align-middle tooltip tooltip--right" 
                        {% if active_dominion.strid in dominion.perk_dict.book_of_grudges %}
                            data-tooltip="{{ dominion.perk_dict.book_of_grudges|getattr:active_dominion.strid|getattr:'pages' }} pages, 
                            +{{ dominion.perk_dict.book_of_grudges|getattr:active_dominion.strid|getattr:"animosity"|floatformat:"1" }}% OP"
                        {% else %}
                            data-tooltip="No grudge against you"
                        {% endif %}
                    >
                        {{ dominion.faction_name|title }}
                    </td>
                    {% else %}
                    <td class="u-align-middle">{{ dominion.faction_name|title }}</td>
                    {% endif %}

                    <td class="u-align-middle">
                        <span class="u-center {% if dominion.protection_ticks_remaining > 0 or not round.has_started %}text-teal-400{% endif %}">
                            {% if dominion.protection_ticks_remaining == 0 and round.has_started %}{{ dominion.defense_short }}{% else %}Magical protection{% endif %}
                        </span>
                    </td>

                    <td>-{{ dominion.complacency_penalty_percent|floatformat:0 }}% DP</td>
                    <td>+{{ dominion.determination_bonus_percent|floatformat:0 }}% OP</td>
                    <td>{{ dominion.highest_op_short }}</td>

                    <td class="u-align-middle">
                        {% if dominion.has_units_returning %}
                        <span class="tag tag--danger py-0 mx-auto">Units returning</span>
                        {% endif %}
                    </td>

                    {% if "book_of_grudges" in active_dominion.perk_dict %}
                    {% if dominion.strid in active_dominion.perk_dict.book_of_grudges %}
                    <td class="u-align-middle">
                        <div class="u-flex u-flex-column u-center">
                            <span>{{ active_dominion.perk_dict.book_of_grudges|getattr:dominion.strid|getattr:"pages" }} pages</span>
                            <span>+{{ active_dominion.perk_dict.book_of_grudges|getattr:dominion.strid|getattr:"animosity"|floatformat:"1" }}% OP</span>
                        </div>
                    </td>
                    {% else %}
                    <td class="u-align-middle">None</td>
                    {% endif %}
                    {% endif %}

                    <td class="u-align-middle">
                        {% if dominion.protection_ticks_remaining == 0 %}
                        <a href="{% url 'overview' dominion.id %}" class="u-center">
                            <button class="py-0 header_colors">Info</button>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="u-none-md">
        {% for dominion in dominions %}
        <div class="card card_colors p-1 max-w-xs">
            <div class="">
                <h6 class="u-center tooltip tooltip--bottom" data-tooltip="Ruler: {{ dominion.associated_user }}">{{ dominion.name }}</h6>
            </div>

            <div class="row u-center">
                <div class="col">
                    <span class="u-center">{{ dominion.faction_name|title }}</span>
                </div>
                <div class="col">
                    {% if dominion.protection_ticks_remaining == 0 %}
                    <a href="{% url 'overview' dominion.id %}" class="u-center">
                        <button class="py-0 header_colors">Info</button>
                    </a>
                    {% endif %}
                </div>
                <div class="col">
                    <span class="u-center">{{ dominion.acres }} acres</span>
                </div>
            </div>

            <div class="row u-center">
                <div class="col">
                    <span class="u-center {% if dominion.protection_ticks_remaining > 0 or not round.has_started %}text-teal-400{% endif %}">
                        {% if dominion.protection_ticks_remaining == 0 and round.has_started %}{{ dominion.defense_short }} DP{% else %}Magical protection{% endif %}
                    </span>
                </div>
                <div class="col u-flex">
                    {% if dominion.has_units_returning %}
                    <span class="tag tag--danger py-0 mx-auto">Units returning</span>
                    {% endif %}
                </div>
                <div class="col">
                    {% if "book_of_grudges" in active_dominion.perk_dict %}
                    {% if dominion.strid in active_dominion.perk_dict.book_of_grudges %}
                    <div class="u-flex u-flex-column u-center">
                        <span>{{ active_dominion.perk_dict.book_of_grudges|getattr:dominion.strid|getattr:"pages" }} pages</span>
                        <span>+{{ active_dominion.perk_dict.book_of_grudges|getattr:dominion.strid|getattr:"animosity"|floatformat:"1" }}% OP</span>
                    </div>
                    {% else %}
                    <span class="u-center">None</span>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
